- name: Utilities
  hosts: all
  gather_facts: yes
  become: yes
  tags:
    - utils
  vars:
    src_dir: "{{ lookup('env', 'HOME') }}/src"
  pre_tasks:
    - name: create src directory
      file:
        path: "{{ src_dir }}"
        state: directory
    - name: update cache
      package:
        update_cache: yes
  tasks:
    - name: install necessary packages
      package:
        name: tmux,stow,binutils,make,gcc
        state: present
    - name: some cool default replacement
      package:
        name: ripgrep,fd,bat
        state: present
    - name: clone Yay (AUR Helper)
      become: no
      git:
        repo: https://aur.archlinux.org/yay.git
        dest: "{{ src_dir }}/yay"
        version: master
      when: ansible_facts['os_family'] == "Archlinux"
    - name: install yay
      command:
        chdir: "{{ src_dir }}/yay"
        cmd: makepkg -si
      when: ansible_facts['os_family'] == "Archlinux"

- name: Fonts
  hosts: all
  tags: fonts
  become: yes
  tasks:
    - name: install fonts
      pacman:
        name: ttf-dejavu,ttf-unifont,ttf-liberation,noto-fonts
        state: present

- name: shell
  hosts: all
  tags: shell
  tasks:
    - name: install zsh
      become: yes
      package:
        name: zsh
        state: present
    - name: change default shell
      command:
        cmd: chsh -s /bin/zsh
    - name: clone fzf
      git:
        repo: https://github.com/junegunn/fzf.git
        depth: 1
        dest: "{{ lookup('env', 'HOME') }}/.fzf"
    - name: install fzf
      command:
        cmd: "{{ lookup('env', 'HOME') }}/.fzf/install"
    # - name: install Zim
    #   command: curl -fsSL https://raw.githubusercontent.com/zimfw/install/master/install.zsh | zsh

- name: Git
  hosts: all
  tags: git
  become: yes
  tasks:
    - name: install git
      package:
        name: git
        state: present
    - name: setup Name, Email and Editor
      command: "{{ item }}"
      with_items:
        - git config --global user.email "hiepph@tuta.io"
        - git config --global user.name "Hiep Pham"
        - git config --global core.editor "vim"

- name: Emacs
  hosts: all
  tags: emacs
  tasks:
    - name: Install emacs
      package:
        name: emacs
        state: present
    - name: setup go
      shell: go get -v golang.org/x/tools/cmd/goimports
    - name: setup python (conda)
      shell: pip install pylint autopep8

- name: Locales
  hosts: all
  tags: locale
  become: yes
  tasks:
    - name: US localization
      shell: localedef -f UTF-8 -i en_US en_US.UTF-8

- name: ibus
  hosts: all
  tags: ibus
  become: yes
  tasks:
    - name: install ibus
      package:
        name: ibus,ibus-unikey
        state: present
    - name: make sure to use appropriate python to open ibus
      lineinfile:
        dest: /usr/bin/ibus-setup
        regexp: /usr/share/ibus/setup/main.py
        line: exec /usr/bin/python3 /usr/share/ibus/setup/main.py $@

- name: SSH
  hosts: all
  gather_facts: no
  become: yes
  tags: ssh
  handlers:
    - name: restart ssh
      service: name=sshd state=restarted

  tasks:
    - name: enable sshd
      service: name=sshd state=started enabled=yes
    - name: update ssh configuration to be more secure
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        validate: 'sshd -t -f %s'
      with_items:
        - regexp: "^PermitRootLogin"
          line: "PermitRootLogin no"
        - regexp: "^Port"
          line: "Port 2406"
      notify: restart ssh
